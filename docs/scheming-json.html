<!DOCTYPE html>

<html>
<head>
  <title>scheming-json.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>scheming-json.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schemingJson</span>(<span class="hljs-params">exports</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="scheming-json">scheming json</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>üòè A lightweight, functional library for describing and validating JSON and JavaScript data</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="general-docs">General Docs</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="describing-json">Describing JSON</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Consider the JSON structure </p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> data = {articles: 
  [{
      title: <span class="hljs-string">'The Title'</span>,
      author: <span class="hljs-string">'The Author'</span>,
      published: <span class="hljs-string">'1/7/53'</span>,
      tags: [
        {tagName: <span class="hljs-string">'Stuff'</span>},
        {tagName: <span class="hljs-string">'Garbage'</span>},
        {tagName: <span class="hljs-string">'uninteresting'</span>}
      ]
    },
    {
      title: <span class="hljs-string">'A title'</span>,
      author: <span class="hljs-string">'Somebody else'</span>,
      published: <span class="hljs-string">'1/8/53'</span>,
      tags: [
        {tagName: <span class="hljs-string">'Stuff'</span>}
      ]
    }
  ]};
</code></pre>
<p>We could describe this using scheming json like so:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> schema = {articles: 
  [{
    title: isString,
    author: isString,
    published: isDateString,
    tags: [{tagName: isString}]
  }]
};
</code></pre>
<p>And get a parser function using</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> articlesParser = parser(schema);

<span class="hljs-keyword">var</span> articlesValid = articlesParser(someArrayofArticles); <span class="hljs-comment">// =&gt; true</span>
<span class="hljs-comment">// hooray!</span>
</code></pre>
<p>Where the functions <code>isString</code>, and <code>isDateString</code> are user-defined (or library-defined) boolean-returning functions (‚Äúpredicates‚Äù).</p>
<p>Alternatively, we could build up smaller schema pieces, and then combine them:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> tag = {tagName: isString};
<span class="hljs-keyword">var</span> article = {title: isString, author: isString, published: isDateString, tags[tag]};
<span class="hljs-keyword">var</span> articles = {articles: [article]};
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="special-values-operators">Special values/operators</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="-">**</h2>
<p><code>**</code> says that we should apply the predicate to all other fields in an object that we haven‚Äôt already specified.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>For example, this would also match our article example</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> singleArticleAlt = {
  title: isString,
  tags: [tag],
  <span class="hljs-string">'**'</span>: isString
};
</code></pre>
<p>This says ‚Äòmatch an object with a key named <code>title</code> that‚Äôs a string, with a key named <code>tags</code> holding an array of tag objects, and with 0 or more keys named anything that are all strings.</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><em>
-
`</em>` says that we should ignore either the key name or the type of value</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> acceptAllNames = {name: <span class="hljs-string">'*'</span>};
</code></pre>
<p>Will match any object with one key called <code>name</code> that has any value.</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>*</code> can also appear in the key selector</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> nameAndFunc = {name: <span class="hljs-string">'*'</span>, <span class="hljs-string">'*'</span>: isFunction};
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>*</code> can be used for multiple key value wildcards. However, since JavaScript object keys must be unique, it must be
written like <code>*something*</code> (any arbitrary name between two *s).</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <pre><code class="lang-javascript"><span class="hljs-keyword">var</span> twoStrings = {<span class="hljs-string">'*a*'</span>: isString, <span class="hljs-string">'*b*'</span>: isString};
</code></pre>
<p>This operator is super buggy right now :-(</p>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="-and-">{} and []</h2>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>The empty object and empty array predicates will match either an object or an array, but not look at its contents.
If we didn‚Äôt care about the contents of our article tags we could have written</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> tagsPresentButUnaccountedFor = {title: isString, author: isString, published: isDateString, tags []};
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If all we wanted to do was make sure that each article in our article array was an object</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> articles_array = {articles: [{}]};
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Both the empty array and empty object notation are shorthands for <code>isArray</code> and <code>isObject</code> predicates.</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="-">$‚Ä¶$</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The dollar sign operators allow lookup of sibling key values within the same object.</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <pre><code class="lang-javascript">  {title: isString, author: myCoolLookupFunction(<span class="hljs-string">'$title$'</span>)}
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Coming soon: how to write functions that can accept <code>$...$</code> arguments.</p>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="composing-predicate-functions">Composing predicate functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The <code>composePredsWith</code> function takes an array of 1-argument predicates and pipes them together using <code>glue</code>.
By default, predicates are glued together with <code>&amp;&amp;</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>As an example, let‚Äôs make a predicate that only allows non-empty arrays</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> isNonEmptyArray = compose1PredsWith([<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> !isEmpty(v)}, isArray], and);
</code></pre>
<p>or a parser that allows either an empty array or an array of tags</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> tagsOrEmpty = compose1PredsWith([parser([tag]), isEmptyArray], or);
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>To hide the explicit function application, scheming json also provides a composer called <code>o</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="the-composer">The Composer</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The composer is an easier way of using <code>composePredicatesWith</code>.
Initiall, the first predicate is wrapped with <code>o</code>, (e.g. <code>o(myPred)</code>),
and subsequent predicates can be combined with it using the 
<code>.and(...)</code>, <code>.or(...)</code>, <code>.nand(...)</code>, and <code>.nor(...)</code> methods.
For example</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> compoundChain = o(myPred).and(myPred1).nand(myPred2);
</code></pre>
<p>To evaluate the chain, either pass in a value after the last item
(i.e. <code>o(myPred).and(myPred1).nand(myPred2)(theValue)</code>)
or use <code>()</code> to get a normal function that can be used on a value</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> compoundPred = o(myPred).and(myPred1).nand(myPred2)();
<span class="hljs-keyword">var</span> result = compoundPred(myVal);
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="-the-rest-of-the-code-">(The rest of the code)</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="definition-of-specials">Definition of Specials</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>Definitions for parsing special operators from strings</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> SPECIALS = [</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>The <code>*</code> operator, matches just <code>&#39;*&#39;</code>, or <code>&#39;*...*&#39;</code> (two <code>*</code> with anything inbetween)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	{name: <span class="hljs-string">'STAR'</span>,		rule: <span class="hljs-regexp">/(?:^\*$)|(?:^\*[^*]+\*$)/</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The <code>**</code> operator, matches just <code>&#39;**&#39;</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	{name: <span class="hljs-string">'STAR_STAR'</span>,	rule: <span class="hljs-regexp">/^\*{2}$/</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The <code>$...$</code> sibling value operator, matches anyting between two <code>$</code>.
The regex captures the content between the dollar signs as a group</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	{name: <span class="hljs-string">'SIBLING'</span>,	rule: <span class="hljs-regexp">/^\$(.+)\$$/</span>}
];</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><strong>Parse out any matching special symbol in a string <code>s</code></strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSpecial</span>(<span class="hljs-params">s</span>) </span>{

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSymbol</span>(<span class="hljs-params">s, regex, selector</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Default to selecting the last regex group in the match
(The matched string if there are no groups, otherwise the last defined group)
This can be overridden using a custom <code>selector</code> funcion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		selector = selector || _.last;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>return any regex matches (<code>String.match</code> returns <code>null</code> (not <code>undefined</code>) if it doesn‚Äôt find any matches)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> matches = s.match(regex);
		<span class="hljs-keyword">if</span> (!_.isNull(matches)) {
			<span class="hljs-keyword">return</span> selector(matches);
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Check to see if <code>s</code> matches against all definitions in <code>SPECIALS</code>
and return an array of matching objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> SPECIALS.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>object with the special name, the result of the parse, and the original input string <code>s</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> {name: v.name, result: parseSymbol(s, v.rule), input: s};
	}).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>filter by any special found (<code>parseSymbol</code> returns <code>undefined</code> if nothing was found)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> !_.isUndefined(v.result);
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="built-in-predicates">Built-in Predicates</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> isArray		=  _.isArray;
<span class="hljs-keyword">var</span> isString 	=  _.isString;
<span class="hljs-keyword">var</span> isBoolean 	=  _.isBoolean;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Note that this is <em>way</em> different from <code>_</code>‚Äòs built-in <code>_.isObject</code> function
it returns true if it‚Äôs an object that‚Äôs not an array or a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> isObject 	= <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{ <span class="hljs-keyword">return</span> (_.isObject(val) &amp;&amp; !_.isArray(val) &amp;&amp; !_.isFunction(val)); };
<span class="hljs-keyword">var</span> isFunction	= _.isFunction;
<span class="hljs-keyword">var</span> isNumber	= _.isNumber;
<span class="hljs-keyword">var</span> isUndefined	= _.isUndefined;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>nb _.isEmpty returns <code>true</code> for primatives like strings and numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> isEmpty 	= _.isEmpty;
<span class="hljs-keyword">var</span> isNonempty	= <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{ <span class="hljs-keyword">return</span> !_.isEmpty(val) }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>used for the <code>*</code> operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> isAnything  = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>see if array a is a subset or b
returns true for improper subsets as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isSubset</span>(<span class="hljs-params">a, b</span>) </span>{
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">s</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> _.uniqWith(x, _.isEqual) }
	<span class="hljs-keyword">return</span> (_.intersectionWith(s(a),s(b),_.isEqual).length === s(a).length);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Logical funcs, to be used with JavaScript‚Äôs built-in operators can‚Äôt be directly passed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">id</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> x; }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">not</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> (!x); };
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">and</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (a &amp;&amp; b); };
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">or</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (a || b); }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nand</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (!a || !b); };
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nor</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (!a &amp;&amp; !b); };</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>for operating on thunked values (see <code>composePredicatesWithWrapped</code> below)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">andWrapped</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (a() &amp;&amp; b()); }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">orWrapped</span>(<span class="hljs-params">a,b</span>) </span>{ <span class="hljs-keyword">return</span> (a() || b()); }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p><strong>Test for a stop value</strong></p>
<p>JSON only has two compound data types, Objects and Arrays.
If something is not an object, or an array, we want to treat it as a value
This is a little fuzzy, since we also want to treat functions as a function value
not an object (even though they are Objects), as it allows is to substitute schema
pieces with parser functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isStopValue</span>(<span class="hljs-params">val</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>since <code>typeof</code> a function is <code>&#39;function&#39;</code>, this will only return true
for the kind of Objects we‚Äôre interested in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isPrimative</span>(<span class="hljs-params">val</span>) </span>{ <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">'object'</span>) }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>now make sure that our object isn‚Äôt an Array, and isn‚Äôt an empty array
since we want to treat empty objects and empty arrays as shorthands for
<code>{} = isObject</code>, and <code>[] = isArray</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> isPrimative(val) || (_.isObject(val) &amp;&amp; _.isEmpty(val)); 
}</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h2 id="utility-functions">Utility Functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><strong>Compose an aray of two-argument predicates together using the chaining function <code>glue</code></strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">composePredicatesWith</span>(<span class="hljs-params">preds, glue</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>if no chaining function is used, default to <code>and</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	glue = glue || and;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>need at least two arguments for and, or, glue etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (preds.length &lt; <span class="hljs-number">2</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>just return a parser for the first item of <code>preds</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> valueParser(preds[<span class="hljs-number">0</span>]);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>otherwise return a function that will compose parsers for each value in <code>preds</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> preds.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, current</span>) </span>{
		<span class="hljs-keyword">var</span> c = valueParser(current);
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{ 
			<span class="hljs-keyword">return</span> glue(acc(x), c(x)); 
		}; 
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p><strong>Compose an aray of two-argument predicates together using the chaining function <code>glue</code>, 
wrapping the values in thunks</strong></p>
<p>Like <code>composePredicatesWith</code>, but it wraps the parsers in thunks
to avoid evaluating a possibly undefined value (like calling <code>.reduce</code> on an object).
This is mainly so that JavaScript‚Äôs built-in short circuiting can skip over evaluating
things we don‚Äôt need to (if for example our first predicate is <code>isArray</code>, and it fails,
don‚Äôt continue evaluating the chain)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">composePredicatesWithWrapped</span>(<span class="hljs-params">preds, glue</span>) </span>{
	glue = glue || andWrapped;

	<span class="hljs-keyword">if</span> (preds.length &lt; <span class="hljs-number">2</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>need at least two arguments for and, or, glue etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> valueParser(preds[<span class="hljs-number">0</span>]);
	}

	<span class="hljs-keyword">return</span> preds.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, current</span>) </span>{
		<span class="hljs-keyword">var</span> c = valueParser(current);
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>wrapping the values allows the boolean short-circuiting
to keep undefined values from being evaluated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> wrapped_acc = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> acc(x); } 
			<span class="hljs-keyword">var</span> wrapped_c = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> c(x); }	

			<span class="hljs-keyword">return</span> glue(wrapped_acc, wrapped_c); 
		}; 
	});
}</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h2 id="the-composer">The Composer</h2>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>The composer is an easier way of using <code>composePredicatesWith</code>.
Initiall, the first predicate is wrapped with <code>o</code>, (e.g. <code>o(myPred)</code>),
and subsequent predicates can be combined with it using the 
<code>.and(...)</code>, <code>.or(...)</code>, <code>.nand(...)</code>, and <code>.nor(...)</code> methods.
For example</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> compoundChain = o(myPred).and(myPred1).nand(myPred2);
</code></pre>
<p>To evaluate the chain, either pass in a value after the last item
(i.e. <code>o(myPred).and(myPred1).nand(myPred2)(theValue)</code>)
or use <code>()</code> to get a normal function that can be used on a value</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> compoundPred = o(myPred).and(myPred1).nand(myPred2)();
<span class="hljs-keyword">var</span> result = compoundPred(myVal);
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o</span>(<span class="hljs-params">initial</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>array of functions that will eventually be chained together</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> funcs = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>used to make sure that there‚Äôs at least one function‚Ä¶ can‚Äôt use <code>o()</code> directly!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> INITIALIZED = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p><strong>Composer utility functions</strong></p>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p><strong>expand</strong> If the function we‚Äôre trying to chain is also a composer, convert the chain
to a function by calling it (allows for nested chains/composition of chains)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">expand</span>(<span class="hljs-params">f</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>check for some meta-data on the function to see if it‚Äôs a normal function
or a composer chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(f.__IS_COMPOSER__) { <span class="hljs-keyword">return</span> f() }
		<span class="hljs-keyword">return</span> f;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><strong>applyState</strong> Transform any two argument function into a new function that applies the threaded state
as the first argument, and an input value to the second argument. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyState</span>(<span class="hljs-params">g</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, x</span>) </span>{
				<span class="hljs-keyword">return</span> (g(state, f(x)));
			}
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><strong>statefulAnd</strong> Short-circuiting <code>and</code>. Takes a function <code>f</code> as a parameter and returns a new function
that acceps the threaded <code>state</code> and a value <code>x</code>. It returns the result of <code>and</code>ing the
threaded state with <code>f(x)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statefulAnd</span>(<span class="hljs-params">f</span>) </span>{ <span class="hljs-comment">// allows short circuit</span>
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, x</span>) </span>{
			<span class="hljs-keyword">return</span> (state &amp;&amp; f(x));
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p><strong>statefulOr</strong> Short-circuiting <code>or</code>. Takes a function <code>f</code> as a parameter and returns a new function
that acceps the threaded <code>state</code> and a value <code>x</code>. It returns the result of <code>or</code>ing the
threaded state with <code>f(x)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statefulOr</span>(<span class="hljs-params">f</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, x</span>) </span>{
			<span class="hljs-keyword">return</span> (state || f(x));
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><strong>statefulNand</strong> Short-circuiting <code>nand</code>. Takes a function <code>f</code> as a parameter and returns a new function
that acceps the threaded <code>state</code> and a value <code>x</code>. It returns the result of <code>nand</code>ing the
threaded state with <code>f(x)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statefulNand</span>(<span class="hljs-params">f</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, x</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>this is equivalent to <code>!(state &amp;&amp; f(x))</code>, but is broken up to allow
short circuiting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> (!state || !f(x));
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p><strong>statefulNor</strong> Short-circuiting <code>nor</code>. Takes a function <code>f</code> as a parameter and returns a new function
that acceps the threaded <code>state</code> and a value <code>x</code>. It returns the result of <code>nor</code>ing the
threaded state with <code>f(x)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">statefulNor</span>(<span class="hljs-params">f</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state, x</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>this is equivalent to <code>!(state || f(x))</code>, but is broken up to allow
short circuiting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> (!state &amp;&amp; !f(x));
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p><strong>threadState</strong> Takes an array of functions that take a threaded state argument, and a value argument
and returns a function that will thread a value <code>v</code> through all the composed chain of functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">threadState</span>(<span class="hljs-params">funcs</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
			<span class="hljs-keyword">return</span> funcs.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc,currentFunc</span>)</span>{
				<span class="hljs-keyword">return</span> currentFunc(acc, v);
			}, initial(v));
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><strong>The main composer function/object</strong></p>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>This is a function, not an object literal so that we can call it
as of es5 there‚Äôs no way to make something callable down the road.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">o_o</span>(<span class="hljs-params"></span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>check to see if it was an <code>()</code> function call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If everything has been properly set up, return the composed function
from the array of <code>funcs</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span>(INITIALIZED) {
				<span class="hljs-keyword">return</span> threadState(funcs);
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Oops, we don‚Äôt have any functions to work with!
Could return the identity function or something here,
(or a function that always returns <code>true</code>), but it seems like
it would probably be an error, not an intentional action on the
part of the user‚Ä¶..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Not initialized!"</span>);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>The call had 1 or more arguments, so we‚Äôre applying the chain to a value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Ff this is the first time we‚Äôve recieved a value, this is the initial
function wrapping (which will be bound to the <code>initial</code> variable named)
in the function definition of <code>function o(initial)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (!INITIALIZED) {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Set our tracker to true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				INITIALIZED = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Return the <code>o</code> composer object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Create a function from the threaded functions and apply the arguments
recieved to the composed function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> threadState(funcs).apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
			}
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Set metadata on the composer function to mark it as a composer chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	o_o.__IS_COMPOSER__ = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Register the <code>.and(...)</code> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	o_o.and = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
		funcs.push(statefulAnd(expand(f)));
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Register the <code>.nand(...)</code> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	o_o.nand = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
		funcs.push(statefulNand(expand(f)));
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Register the <code>.or(...)</code> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	o_o.or = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
		funcs.push(statefulOr(expand(f)));
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Register the <code>.nor(...)</code> method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	o_o.nor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
		funcs.push(statefulNor(expand(f)));
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Return the composer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> o_o;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <h2 id="other-utilities-types">Other utilities/types</h2>

            </div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p><strong>thunk</strong> Represent a thunk, used for the $sibling$ paser
could and probably should be refactored to use the composer/chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">thunk</span>(<span class="hljs-params">f</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>return a function taking an array of arguments to appy to <code>f</code> when the thunk
is executed, and a value for the <code>this</code> argument to be used for <code>f</code>. If no argument
is given, <code>undefined</code> is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> theThunk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, thisArg</span>) </span>{
		<span class="hljs-keyword">return</span> f.apply(thisArg, [].concat(args));
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>set metadata on the thunk function to identify it as a thunk</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	theThunk.__IS_THUNK__ = <span class="hljs-literal">true</span>;
	<span class="hljs-keyword">return</span> theThunk;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p><strong>Failure</strong> Optional type used for chaining objects to nuke the chain if one step fails.
The <code>fakeFunctionNames</code> argument in the constructor is a list of method names
that the <code>Failure</code> object should have to make it indistinguishable to the original
object‚Äôs API.
When a failure occurs, a Failure object can be swapped in for the original object
and the failure propagages down the chain (since Failure will return an identical Failure
object for any method call)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Failure</span>(<span class="hljs-params">fakeFunctionNames</span>) </span>{
	fakeFunctionNames = fakeFunctionNames || [];
	<span class="hljs-keyword">var</span> fail = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>create Failure-returning functions for each of the fake method names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	fakeFunctionNames.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{
		fail[v] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Failure (fakeFunctionNames) }
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Register the fake methods onto the failure object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_.merge(<span class="hljs-keyword">this</span>, fail);

	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p><strong>parseSiblingVar</strong> Parse a ‚Äò$Sibling$‚Äô special. Takes a string value <code>v</code>, and a function <code>f</code> that dispatches
on the value returned by the sibling parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSiblingVar</span>(<span class="hljs-params">v, f</span>) </span>{
	<span class="hljs-keyword">var</span> token = parseSpecial(v).filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">t</span>)</span>{ <span class="hljs-keyword">return</span> t.name === <span class="hljs-string">'SIBLING'</span>; })[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">if</span>(token) {
		<span class="hljs-keyword">return</span> thunk(f(token.value));
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p><strong>parseSiblingKey</strong> Takes a key name, and returns a function taking an object <code>d</code>, and a value <code>val</code>
and check to see whether the value of <code>keyName</code> in the object is equal to <code>val</code>
Used in the <code>$sibling$</code> special parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseSiblingKey</span>(<span class="hljs-params">keyName</span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d, val</span>) </span>{
		<span class="hljs-keyword">if</span>(d[keyName]) {
			<span class="hljs-keyword">return</span> _.isEqual(d[keyName], val);
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <h2 id="parsers">Parsers</h2>

            </div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p><strong>valueParser</strong> Return a predicate for a value v
Defaults to a parser that check to see if any input is equal to v</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valueParser</span>(<span class="hljs-params">v</span>) </span>{
	<span class="hljs-keyword">var</span> p = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>)</span>{ <span class="hljs-keyword">return</span> _.isEqual(x,v); };

	<span class="hljs-keyword">if</span> (_.isObject(v))		p = isObject;
	<span class="hljs-keyword">if</span> (_.isArray(v))		p = isArray;
	<span class="hljs-keyword">if</span> (_.isUndefined(v))	p = isUndefined;
	<span class="hljs-keyword">if</span> (_.isFunction(v))	p = v;

	<span class="hljs-keyword">return</span> p;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p><strong>arrayParser</strong> Returns compound parser for each item inside of an array <code>a</code> (using <code>and</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arrayParser</span>(<span class="hljs-params">a</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>get a parser for each value inside of <code>a</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> preds = a.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{ <span class="hljs-keyword">return</span> parser(v); });</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>ugh, this always returns true for an empty list. what is a sane default? 
Compose all the parsers in <code>preds</code> into one big function that will
match all the criteria defined in <code>a</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processArray</span>(<span class="hljs-params">a</span>) </span>{
		<span class="hljs-keyword">var</span> p = composePredicatesWith(preds, and);
		<span class="hljs-keyword">return</span> a.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, current</span>)</span>{
			<span class="hljs-keyword">return</span> acc &amp;&amp; p(current);
		}, <span class="hljs-literal">true</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>wrap values to make sure if isArray fails, the rest of the computation short circuits
otherwise the call to a.reduce generates an exception</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> composePredicatesWithWrapped([isArray, processArray], andWrapped);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p><strong>objectParser</strong> Returns a compound parser matching schema rules for each key and value of an object <code>o</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">objectParser</span>(<span class="hljs-params">o</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>For holding the specials we parse out from the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> SPECIALS_USED;
	<span class="hljs-keyword">var</span> SPECIALS_ENV;</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p><strong>Returns true if we are parsing any specials</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SPECIALS_PRESENT</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> _.keys(SPECIALS_ENV.preds).length &gt; <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p><strong>Filter out any keys in the object that we‚Äôre going to parsing in a special
and remove them from the general pool of keys we‚Äôre going to consider.</strong></p>
<p>Takes a <code>config</code> object with</p>
<ul>
<li>the object we‚Äôre parsing,</li>
<li>The keys that we‚Äôre going to parse</li>
<li>and an array of any specials found to be used in the object and want to test for 
and remove keys from general consideration.</li>
<li>and a special name <code>specialName</code></li>
</ul>
<p>Returns a specials object with same key names a <code>config</code>, but with keys that have 
been filtered according to the rules of the special, and object contining all the
necessary predicates to parse the special on the object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genericStar</span>(<span class="hljs-params">config<span class="hljs-comment">/*={obj, keys, specialsInObject}*/</span>, specialName</span>)</span>{
		<span class="hljs-keyword">var</span> obj = config.obj;
		<span class="hljs-keyword">var</span> keys = config.keys;
		<span class="hljs-keyword">var</span> specialsInObject = config.specialsInObject;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Only look at the specials that match <code>specialName</code>, and then get the schema object
values (which hold predicates) for each key that has the special.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> preds = specialsInObject.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{ <span class="hljs-keyword">return</span> v.name === specialName }).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{ <span class="hljs-keyword">return</span> obj[v.input] });</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>All the rest of the keys that don‚Äôt use any special operator
by checking to see if the key value matches an input for a found
parsed special</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> remainingKeys = keys.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{ 
			<span class="hljs-keyword">var</span> notInSpecials = specialsInObject.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, parsedSpecial</span>)</span>{
				<span class="hljs-keyword">return</span> acc &amp;&amp; (v !== parsedSpecial.input);
			}, <span class="hljs-literal">true</span>);
			<span class="hljs-keyword">return</span> notInSpecials;
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>If there are any specials used in the object we‚Äôre considering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (preds.length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>get any already registered preds for this special name
and combine them with the ones we found.
Start with an empty array to give a default if config.preds[SpecialName]
is undefined (i.e. not registered)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			config.preds[specialName] = [].concat(config.preds[specialName]).concat(preds)
		}

		<span class="hljs-keyword">return</span> {obj: obj, keys: remainingKeys, specialsInObject: specialsInObject, preds: config.preds};
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p><strong>Return a parser for a special called <code>SPECIAL_NAME</code> using the special evaluator <code>f</code></strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_special</span>(<span class="hljs-params">f, SPECIAL_NAME</span>)</span>{
		<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Look up the preds we need for the special in the <code>SPECIALS_ENV</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> preds = SPECIALS_ENV.preds[SPECIAL_NAME];</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Get the keys that don‚Äôt use specials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> remaining_keys = SPECIALS_ENV.keys;</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Get the keys that do use specials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> affected_keys = _.difference(_.keys(obj), remaining_keys);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Apply the evaluator <code>f</code> for our special and return the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> f(obj, remaining_keys, affected_keys, preds);
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p><strong>The evaluator for the * special</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_star</span>(<span class="hljs-params">obj, remaining_keys, affected_keys, preds</span>) </span>{
			<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incrementIfExists</span>(<span class="hljs-params">o, k, inc</span>) </span>{
				<span class="hljs-keyword">if</span>(o[k]) {
					o[k] = o[k] + inc;
				} <span class="hljs-keyword">else</span> {
					o[k] = inc;
				}
				<span class="hljs-keyword">return</span> o;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>we need to count each distinct predicate function ‚Ä¶ there is no way to distinguish
between two functions that <em>do</em> the same thing, so beware‚Ä¶‚Ä¶.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> pred_counts = preds.reduce( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, p</span>)</span>{ <span class="hljs-keyword">return</span> incrementIfExists(acc, p, <span class="hljs-number">1</span>); }, {});</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>now, take all the keys leftover from the object that aren‚Äôt in ‚Äòkeys‚Äô
apply all the star preds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> pred_successes = preds.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc_outer, p</span>)</span>{
				<span class="hljs-keyword">var</span> successes = affected_keys.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc,current</span>)</span>{
					<span class="hljs-keyword">if</span>(parser(p)(obj[current])) {
						<span class="hljs-keyword">return</span> acc +<span class="hljs-number">1</span>;
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">return</span> acc;
					}
				}, <span class="hljs-number">0</span>);
				incrementIfExists(acc_outer, p, successes);
				<span class="hljs-keyword">return</span> acc_outer;
			}, {});</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>and count how many trues there are, and make sure the numbers match up!
console.log(pred_counts, pred_successes);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> _.isEqual(pred_counts, pred_successes);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p><strong>evaluator for the </strong> special**</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_star_star</span>(<span class="hljs-params">obj, remaining_keys, affected_keys, preds</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>make sure that any of the preds used for the ** special
are true all keys that are going to be evaulated using the special</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> affected_keys.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a,k</span>)</span>{
			<span class="hljs-keyword">var</span> predsMatchForK = preds.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc,p</span>)</span>{
				<span class="hljs-keyword">return</span> (acc || parser(p)(obj[k]))
			}, <span class="hljs-literal">false</span>);
			
			<span class="hljs-keyword">return</span> (a &amp;&amp; predsMatchForK);
		}, <span class="hljs-literal">true</span>);
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p><strong>Evaluator for keys that don‚Äôt use specials</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_regular_keys</span>(<span class="hljs-params">obj</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>The keys we expected to find, based on the schema</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> expected_keys = SPECIALS_ENV.keys;</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Keys in the object that we found that weren‚Äôt described in the schema</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> unexpected_keys = _.difference(_.keys(obj), expected_keys);</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Make sure all of the predicates in the schema hold for the expected keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> expected_valid = expected_keys.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc,k</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>The top level object from <code>objectParser(o)</code>, should probably refactor out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> currentPred = parser(o[k]);
			<span class="hljs-keyword">if</span>(currentPred.__IS_THUNK__) {</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Pass in the object context if our pred is a thunk
used for <code>$sibling$</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">return</span> acc &amp;&amp; currentPred([obj, obj[k]]);
				}
			<span class="hljs-keyword">return</span> acc &amp;&amp; currentPred(obj[k]);
		}, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Is it ok that we have any unexpected keys? If we‚Äôre using specials, yes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> unexpected_ok = SPECIALS_PRESENT();</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Return false if we found unexpected values and weren‚Äôt using specials,
otherwise return our results for evaluating the expected keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> (unexpected_keys.length &gt; <span class="hljs-number">0</span>)? (expected_valid &amp;&amp; unexpected_ok) : expected_valid;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p><strong>Test the object‚Äôs keys using <code>test_regular_keys</code> and any specials evaulators</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testObjectKeys</span>(<span class="hljs-params">obj</span>) </span>{
		<span class="hljs-keyword">var</span> regular = test_regular_keys(obj);
		<span class="hljs-keyword">var</span> specials = SPECIALS_USED.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc, current</span>)</span>{
			<span class="hljs-keyword">if</span>(SPECIALS_ENV.preds[current]) {
				<span class="hljs-keyword">return</span> acc &amp;&amp; SPECIALS_ENV.test[current](obj);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">return</span> acc;
			}
		}, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>If we‚Äôre using specials, make sure that both the specials evaluation
and the regular evaluation are true. Otherwise, we only care that the regular
keys are true;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> (SPECIALS_PRESENT())? (regular &amp;&amp; specials) : regular;
	}


	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">equalKeys</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> _.isEqual(_.keys(x).sort(), SPECIALS_ENV.keys.sort()); }
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subSetKeys</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> isSubset(SPECIALS_ENV.keys, _.keys(x)); }</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Get an array of specials used in the object by testing each key in <code>o</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> specialsInObject = _.flatten(_.keys(o).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{ <span class="hljs-keyword">return</span> parseSpecial(v) }));</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Define which specials we‚Äôre going to test for in the object keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> SPECIALS_USED = [<span class="hljs-string">'STAR_STAR'</span>, <span class="hljs-string">'STAR'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Set up our environment by filtering out the keys that are used by specials
from the regular object keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> SPECIALS_ENV = SPECIALS_USED.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">acc,current</span>)</span>{
			<span class="hljs-keyword">return</span> genericStar(acc, current);
		}, {obj: o, keys: _.keys(o), specialsInObject: specialsInObject, preds: {}});</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Register our specials evaluators with the environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	SPECIALS_ENV.test = {};
	SPECIALS_ENV.test[<span class="hljs-string">'STAR'</span>] = test_special(test_star, <span class="hljs-string">'STAR'</span>);
	SPECIALS_ENV.test[<span class="hljs-string">'STAR_STAR'</span>] = test_special(test_star_star, <span class="hljs-string">'STAR_STAR'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Start building up the object parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> preds = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Add object test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	preds.push(testObjectKeys);</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Ff no specials are used we want to be more strict that all keys in the object match
the keys specified in the schema.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (SPECIALS_PRESENT()) {
		preds.push(subSetKeys);</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Otherwise, make sure that the keys in the schema that aren‚Äôt specials related
are included in the object we‚Äôre testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	} <span class="hljs-keyword">else</span> {
		preds.push(equalKeys);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Can‚Äôt be {} (since we‚Äôre using that as a shorthand for isObject)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	preds.push(isNonempty);</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Make sure it‚Äôs really an object! If this fails, all other tests will be skipped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	preds.push(isObject);</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Return the composed object parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> composePredicatesWithWrapped(preds, andWrapped);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p><strong>The combined parser generator</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parser</span>(<span class="hljs-params">v</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>default value parser fallback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> p = valueParser;</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>dispatch on arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (isArray(v)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>if [], make it a shortcut for isArray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(isEmpty(v)) {
			p = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>)</span>{ <span class="hljs-keyword">return</span> isArray; };</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>override valueParser, and use the schema parser for arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		} <span class="hljs-keyword">else</span> {
			p = arrayParser;
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>dispatch on object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (isObject(v)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>if {}, make it a shortcut for isObject</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(isEmpty(v)) {
			p = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> isObject; };</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>override valueParser, and use the schema parser for objects
(Note that this def of isObject excludes arrays and functions.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		} <span class="hljs-keyword">else</span> {
			p = objectParser;
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>dispatch on string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (isString(v)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>test for the presence of any specials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> specials = parseSpecial(v);
		<span class="hljs-keyword">if</span>(specials.length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>right now we‚Äôre assuming that there can only be one special
per string (which isn‚Äôt true), but this works for now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">switch</span> (specials[<span class="hljs-number">0</span>].name) {</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>match <code>*</code> up to isAnything</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">case</span> <span class="hljs-string">'STAR'</span>:
					p = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>)</span>{ <span class="hljs-keyword">return</span> isAnything; };
					<span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>match up <code>$...$</code> to the sibling parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">case</span> <span class="hljs-string">'SIBLING'</span>:
					p = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>)</span>{<span class="hljs-keyword">return</span> parseSiblingVar(x, parseSiblingKey)};
					<span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>otherwise use the default parseSpecial parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">default</span>:
					p = parseSpecial;
			}
		};
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>return the dispatched parser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> p(v);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>register the components to export</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports[<span class="hljs-string">'parser'</span>] = parser;
exports[<span class="hljs-string">'o'</span>] = o;
exports[<span class="hljs-string">'Failure'</span>] = Failure;

<span class="hljs-keyword">return</span> exports;

};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
